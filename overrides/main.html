{% extends "base.html" %}

{% block site_meta %}
  {{ super() }}
  {% if config.extra.canonical_base %}
    <meta name="canonical-base" content="{{ config.extra.canonical_base }}">
  {% endif %}

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ base_url }}/assets/apple-touch-icon.png">
  <link rel="icon" href="{{ base_url }}/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ base_url }}/assets/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ base_url }}/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="{{ base_url }}/assets/favicon-64x64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ base_url }}/assets/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ base_url }}/assets/android-chrome-512x512.png">
  <link rel="manifest" href="{{ base_url }}/assets/site.webmanifest">
  <link rel="mask-icon" href="{{ base_url }}/assets/safari-pinned-tab.svg" color="#0b6428">
  <meta name="msapplication-TileColor" content="#f7f1e6">
  <meta name="theme-color" content="#ffffff">

  {# -- SEO Metadata (OpenGraph, Twitter, Structured Data) ------------------ #}
  {% set meta = page.meta if page and page.meta else {} %}

  {# -- Canonical URL ------------------------------------------------------- #}
  {% if page and page.canonical_url %}
    {% set canonical = page.canonical_url %}
  {% elif meta.canonical_url %}
    {% set canonical = meta.canonical_url %}
  {% elif config.site_url and page and page.url %}
    {% set canonical = config.site_url ~ page.url %}
  {% else %}
    {% set canonical = None %}
  {% endif %}

  {% if canonical %}
    <link rel="canonical" href="{{ canonical | e }}">
  {% endif %}

  {# -- Basic metadata ------------------------------------------------------ #}
  {% set title = meta.og_title or meta.title or page.title or config.site_name %}
  {% set description = meta.og_description or meta.description or config.site_description %}
  {% set robots = meta.robots if meta.robots is defined else none %}
  {% set keywords = meta.keywords %}
  {% set author = meta.author or config.site_author %}

  {% if description %}
    <meta name="description" content="{{ description | e }}">
  {% endif %}
  {% if author %}
    <meta name="author" content="{{ author | e }}">
  {% endif %}
  {% if robots is not none %}
    <meta name="robots" content="{{ robots | e }}">
  {% endif %}
  {% if keywords %}
    <meta name="keywords" content="{{ keywords | e }}">
  {% endif %}

  {# -- Open Graph metadata ------------------------------------------------- #}
  {% set og_type = meta.og_type or 'website' %}
  {% set og_url = meta.og_url or canonical %}

  {# Build image URL - check for custom og_image in frontmatter first #}
  {% if meta.og_image %}
    {# If og_image is relative, make it absolute for social media #}
    {% set og_img = meta.og_image %}
    {% if og_img[0:4] == "http" %}
      {% set image = og_img %}
    {% else %}
      {% set image = "https://safeaiaus.org/" ~ og_img %}
    {% endif %}
  {% else %}
    {# Use the SafeAI logo for social sharing (absolute URL required for social media) #}
    {% set image = "https://safeaiaus.org/assets/safeaiaus-logo-600px.png" %}
  {% endif %}

  <meta property="og:site_name" content="{{ config.site_name | e }}">
  <meta property="og:title" content="{{ title | e }}">
  {% if description %}
    <meta property="og:description" content="{{ description | e }}">
  {% endif %}
  <meta property="og:type" content="{{ og_type | e }}">
  {% if og_url %}
    <meta property="og:url" content="{{ og_url | e }}">
  {% endif %}
  {% if image %}
    <meta property="og:image" content="{{ image | e }}">
  {% endif %}

  {# -- Twitter metadata ---------------------------------------------------- #}
  {% set twitter_card = meta.twitter_card or 'summary_large_image' %}
  {% set twitter_title = meta.twitter_title or title %}
  {% set twitter_description = meta.twitter_description or description %}
  {% set twitter_image = meta.twitter_image or image %}
  {% set twitter_site = meta.twitter_site or '@safeai_aus' %}
  {% set twitter_creator = meta.twitter_creator or twitter_site %}

  <meta name="twitter:card" content="{{ twitter_card | e }}">
  <meta name="twitter:title" content="{{ twitter_title | e }}">
  {% if twitter_description %}
    <meta name="twitter:description" content="{{ twitter_description | e }}">
  {% endif %}
  {% if twitter_image %}
    <meta name="twitter:image" content="{{ twitter_image | e }}">
  {% endif %}
  {% if twitter_site %}
    <meta name="twitter:site" content="{{ twitter_site | e }}">
  {% endif %}
  {% if twitter_creator %}
    <meta name="twitter:creator" content="{{ twitter_creator | e }}">
  {% endif %}

  {# Note: Git revision dates not yet supported in Zensical - will be re-enabled when available #}

  {# -- FAQ structured data (curated per page) ------------------------------ #}
  {% if meta.faq %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {% for item in meta.faq %}
        {
          "@type": "Question",
          "name": {{ item.question | tojson }},
          "acceptedAnswer": {
            "@type": "Answer",
            "text": {{ item.answer | tojson }}
          }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    }
    </script>
  {% endif %}

  {# -- HowTo structured data (opt-in per page) ----------------------------- #}
  {% if meta.howto %}
    {% set howto_name = meta.howto.name or title %}
    {% set howto_description = meta.howto.description or description %}
    {% set howto_steps = meta.howto.steps or [] %}
    {% if howto_steps and howto_name and howto_description %}
      <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "HowTo",
        "name": {{ howto_name | tojson }},
        "description": {{ howto_description | tojson }},
        "step": [
          {% for step in howto_steps %}
          {
            "@type": "HowToStep",
            "name": {{ step.name | default(step.title) | default("Step " ~ loop.index) | tojson }},
            "text": {{ step.text | default(step.description) | tojson }}
          }{% if not loop.last %},{% endif %}
          {% endfor %}
        ]
      }
      </script>
    {% endif %}
  {% endif %}
{% endblock %}

{% block content %}
  {{ super() }}

  <!-- SafeAI-Aus Knowledge Assistant Chat Widget -->
  <div id="airia-chat-root"></div>
  <script type="module">
    import AiriaChat from "https://prodaus.embed-api.airia.ai/get-chat-embed.js"
    AiriaChat.init({
      pipelineId: "082a8566-0662-4ce1-83fb-42503ac7fb64",
      apiKey: "ak-MTk2NTI1MjYwNnwxNzY3MzUxOTcwNzczfHRpLWMybHRjR3hsWm5rdVlXa3R8MXw5MTE4ODgyMTQg",
      apiUrl: "https://prodaus.embed-api.airia.ai",
      greeting: "Hi! I can help you find AI safety resources and answer questions about Australian AI governance. What would you like to know?",
      imagePath: "{{ base_url }}/assets/safeai-aus-chat-logo-compressed.png",
      imageSize: "medium",
      imageBgColor: "#FFFFFF",
      imageBorderColor: "#0b6428",
      imageBorderWidth: "3px",
      autoOpen: false
    })
  </script>
{% endblock %}
